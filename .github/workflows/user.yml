name: Run Appium Tests
run-name: OlxApp tests

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ENV:
        type: choice
        description: "Environment"
        options:
          - prod
      TAG:
        description: "Tag to execute"
        required: true
        default: "@Regression"

jobs:
  test:
    runs-on: ubuntu-latest
    name: Emulator + Appium + Tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Start Android Emulator + Appium + Run tests
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          emulator-options: -no-window -no-audio -no-snapshot -gpu swiftshader_indirect
          disable-animations: true
          script: |
            set -euo pipefail
            echo "Restarting adb..."
            adb kill-server || true
            adb start-server

            echo "List devices (initial):"
            adb devices || true

            # Espera até o emulator aparecer como 'device'
            echo "Waiting for emulator to be available as device..."
            for i in $(seq 1 60); do
              state=$(adb devices | awk '/emulator-5554/ {print $2}' || true)
              echo "Attempt $i: emulator state='$state'"
              if [ "$state" = "device" ]; then
                echo "Emulator present as device"
                break
              fi
              sleep 5
            done

            # Espera pelo boot completo
            echo "Waiting for Android boot_completed..."
            for i in $(seq 1 60); do
              boot=$(adb -s emulator-5554 shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
              echo "Attempt $i: boot_completed='$boot'"
              if [ "$boot" = "1" ]; then
                echo "boot_completed == 1"
                break
              fi
              sleep 5
            done

            adb -s emulator-5554 wait-for-device
            adb -s emulator-5554 shell input keyevent 82 || true
            sleep 1

            echo "Installing app APKs..."
            adb -s emulator-5554 install-multiple apps/base.apk apps/split_config.x86_64.apk apps/split_config.xxhdpi.apk || (echo "APK install failed" && adb -s emulator-5554 shell pm list packages | head -n 50 && false)

            echo "Starting Appium..."
            # Use npx para não depender de global install
            npm i -g appium@latest appium-doctor || true
            npx appium --address 127.0.0.1 --port 4723 --log-level info --log appium.log &

            # Aguarda porta do Appium responder
            for i in $(seq 1 30); do
              if nc -z 127.0.0.1 4723 >/dev/null 2>&1; then
                echo "Appium responding on port 4723"
                break
              fi
              echo "Waiting for Appium to start... ($i)"
              sleep 2
            done

            echo "Running tests..."
            mvn clean test -Dcucumber.filter.tags="${{ github.event.inputs.TAG }}"

      - name: Generate Cucumber Report
        if: always()
        run: |
          echo "Conteúdo da pasta target:"
          ls -R target || true
          mkdir -p cucumber-report
          cp -r target/cucumber-reports/* cucumber-report/ || true

      - name: Upload Cucumber Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-report
          path: cucumber-report

      - name: Upload Appium log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log
          path: appium.log